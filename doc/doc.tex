\documentclass{article}
\usepackage{amsmath}
\usepackage{amssymb}

\begin{document}

\section{Purpose}
Many cartoons of semiconductor device cross-sections are sufficiently simple that routines can be made for their construction. This package provides utilities for scripting the creation of semiconductor device cross-sections. 

\section{Coordinate System}
The global Cartesian coordinate system has origin taken to be the lower left hand corner of the schematic. Cartesian subdomains of the graphics canvas, are rectangular in shape with origin in their lower left hand corner.

\section{Description of Objects}\label{sec:oop}

The objects are, in ascending order of class hierarchy (in the sense of which objects contain lower objects, not which objects are subclasses of which objects), features, layers, and devices. The objects are immutable and contain both mutable and immutable attributes. The layer object creates many features provided one or no feature, and the device object modifies layers and the features they contain. Both devices and layers are effectively lists with construction methods and attributes. One can access the desired layers through device items or features through layer items as well as the references (named variables) assigned to them.

\subsection{Schematic}
The schematic is a collection of devices and only is used to layout the partially created devices in sequence for diagrams illustrating semiconductor fabrication processes.

\subsection{Device}
The device is a collection of layers and has no parameters which directly affect the drawing of features. Rather it maintains a stack height on which to deposit another layer. Importantly layers may be stacked in a list or successively. Those layers which are stacked in a list will be stacked at the same height (overlapping).

One consequence of stacking layers a the same height is is that one cannot have a memoryless stack, since the unstack operation won't know which layers were stacked as a list and which were not. This requires a list of the height at which each layer was stacked and is given variable name \texttt{stack\_base}.

In addition to a stack which defines the height at which each layer is drawn, there may generally be a different stack desired which defines the drawing precedence. This is in cases where, instead of clipping features, it may be desired to draw over their parts. This is not implemented, but if the entries in the stack are permuted (which is easily achieved by list indexing, though the stack data structure is bad for permuting), it may be achieved.

\subsection{Layer}

As defined, a layer has the attributes of phase, period, domain, and feature. The period is here synonymous with pitch. The phase is best reported as a phase fraction varying from 0 to 1. The start of the first feature $c$, the phase fraction $\phi$, and the period $p$ are related by

$$ \phi = \bmod(c, p) \,.$$

The device width restricts features on some $0 < x < L$. For features within the device width but whose widths extend out of it, clipping can be used. 

Since the first feature is in the first period it follows

$$c = \phi p \,. $$

Quite often it is preferred to specify the starting location of a feature, which is related to a phase shift (provided the appropriate domain restriction has been imposed) as

$$ x_0 = p (q + \phi) \,. $$

where $q$ is the integral quotient of $c/p$.

If more than the number of degrees of freedom is specified, the program is permissive and assumes they add in contribution.

\subsection{Feature}

A feature may be having a shape and size. The resulting layer height depends on the shape and size of the feature, and shape and size are usually more than one parameter each--only regular polygons are defined by a single string parameter for shape (which is just a map to a number of vertices, hence the name $n$-gon) and a single size parameter (edge length). A feature may have any other aesthetic attributes such as color. For the purpose of layering it must have a lowermost base, though the base may be a point such as in an upside down triangle.

A feature does not have position as an attribute but a place method. This makes it easy to translate the containing objects. 

\subsubsection{Polygon Features}
Polygons under the constraint that no two points share the same phase angle and the shape is closed around the origin, are easily generally accounted for by ordering the coordinates by polar angle $\theta = \arctan2(x,y)$ and then drawing lines between these ordered coordinates. Some routines such as the algorithm for conformal layer may depend on polygons being convex. The object methods 

\subsubsection{Non-linear features}
Non-linear features require vector graphics programs to be efficiently rendered. Standard non-linear shapes such as circles and ellipses are supported by the vector graphics programs. In general, numerical algorithms approximating these as composed of polygons are required. 

\section{Clipping}
A layer has a defining box (=subdomain). The coordinates of a layer are defined relative to a lower left hand corner of a layer box for which features outside are clipped. The domain of the layer determines the $x$-coordinates of this box, and since layers are stacked, in the layer coordinate system those coordinates below 0 and above the prescribed layer height are also to be clipped. The layer height is taken as the feature height unless explicitly given.

When a layer is shifted because it is stacked onto a device or a device containing it is stacked onto a schematic, there must be a change in the bounding box so that the feature placement won't be clipped. That is, the bounding box coordinates are translated with all other coordinates.

\section{Copying} 
%the copy methods as written are deep copy methods because they copy all the references recursively, e.g., copying a device copies also the layers and also the features
Each object has a copying method defined for it. Because features are repeated their copying is used in layer creation. For creating conformal layers it is easiest to copy a given layer and apply a transform to all its features (which are also copied). Devices are copied for making schematics which show the creation of a device by a sequence of steps.

When making copying methods, generally it is important to take note of attributes which are changed in the layer after its initialization. The new class instance resulting from copying will not have default values the same as the old class instance which it is copying.

\section{Convenience Functions for Symmetric Placement of Features in Layers}

If the domain $w_l$ is not equal to $np + w$ where $n$ is an integer and $w$ is the feature width, it will not be symmetric in the domain. Given the period, the offset required (when the remainder is non-zero) is 

$$x_0 = \frac{w_l - \text{floor}(w_l / p) + 1}{2} - \frac{w_f}{2}\,. $$

Of course $w_f$ should be such that $x_0 > 0$. This is found by solving the equation

$$x_0 + \frac{w_f}{2} + np + \frac{w_f}{2} + x_0 = w_l\,, $$

which is the required distance $x_0$ so that the distances from the endpoints of the domain to the center of the nearest feature are equal. The feature at the beginning moves at most half a period to the right, as expected. Here $n$ is the number of periods which fit while allowing for equal offset of the features from either side of the layer. This equation is solved iteratively for general $w_l$ since the spacing $x_0$ is unknown yet the quotient depends on it since the periods are to span between the unknown offsets $x_0$.

%The feature width is irrelevant, only the period and device width appearing in the above equation, and this is also expected (consider larger features with correspondingly smaller separations so that the period remains the same).

A features spacing $s_f$ between neighboring features, which is equal to the feature padding, is related to the period of the layer it is in $p$ and the feature width $w_f$ by

$$p = w_f + s_f \,.$$

Hence provided a desired feature width and spacing, the correct period and offset for symmetry can be calculated.

There is also in general a desire to put in a number of features and a feature width and calculate the required period (which will be integral, since the provided number of features is integral). The period is related to the layer width, feature width, and number of features by

$$ w_l = (n-1)p + w_f\,. $$

%TODO add the case when features are split symmetrically, half on either side

\section{Conformal Layers}

Given $\mathbf{p}_i$, $\mathbf{p}_{i+1}$, \ldots where $\mathbf{p}_i$ is the vertex which forms an edge with $\mathbf{p}_{i-1}$ and $\mathbf{p}_{i+1}$, there are the following definitions:

\begin{enumerate}
    \item The perpendicular bisector of the edge $e_{i+1}$ defined between $\mathbf{p}_i$ and $\mathbf{p}_{i+1}$ is a line which intercepts the average of the two vertices, $\mathbf{b}_i = (\mathbf{p}_i + \mathbf{p}_{i+1})/2$, and has as slope $$\mathbf{m}_i = \mathbf{R}\mathbf{d}_{i+1}$$ where $\mathbf{d}_{i+1} = \mathbf{p}_{i+1} - \mathbf{p}$ is the vector with length and slope of the edge and $\mathbf{R}$ is the rotation matrix 2-D, that is, $\mathbf{R} \equiv ((0,1),(-1,0))$
    \item The angular bisector of the vertex $\mathbf{p}_i$, denoted $a_i$, is a line which intercepts $\mathbf{b}_i' = \mathbf{p}_i$ and has as slope 
        $$ \mathbf{m}_i' = (\mathbf{p}_i - \mathbf{p}_{i+1}) + (\mathbf{p}_i - \mathbf{p}_{i-1})  = 2\mathbf{p}_i - \mathbf{p}_{i+1} - \mathbf{p}_{i-1} \,. $$
\end{enumerate}

The perpendicular bisector $e_{i+1}$ intercepts the angular bisector $a_i$ at one point and forms a triangle with the other two intercepts already known for the perpendicular bisector and the angular bisector on the polygon perimeter. The equation for the intercept is

$$ x_i \mathbf{m}_i + \mathbf{b}_{i} = x_i' \mathbf{m}_{i+1}' + \mathbf{b}_i'\,.$$

Then there is a linear equation to be solved for the extent along each line, $\mathbf{x}_i$

$$ \begin{pmatrix} \mathbf{m}_i & -\mathbf{m}_{i+1}' \end{pmatrix} \mathbf{x}_i = \mathbf{b}_i' - \mathbf{b}_i \,.$$

    The intercept position $\mathbf{y}_i$ is easily calculated from this by substituting into either of the starting linear equations the relevant extent along that slope. In order to create a conformal geometric layer, that triangle should be magnified to a similar triangle. The angle may be found as 

$$\cos\theta = \frac{ (\mathbf{b}_i - \mathbf{y}_i) \cdot (\mathbf{b}_i' - \mathbf{y}) }{ \Vert \mathbf{b}_i - \mathbf{y}_i \Vert \Vert \mathbf{b}_i' - \mathbf{y}_i \Vert } \,.  $$

The coordinate of the conformal layer is given by some constant increment from the perpendicular bisector intercept outward along the perpendicular bisector. Its other coordinate is then given by that increment scaled by the trigonometric factor from the angle bisector intercept outward along the angle bisector. This assumes that the intercept is always interior to the polygon, and that the distance to the vertex is greater than the distance to the perpendicular bisector. The edge should always form a leg of the triangle, the line segment from $\mathbf{y}_i$ to $\mathbf{b}_i$ another leg, and the line segment from $\mathbf{y}_i$ to $\mathbf{b}_i'$ the hypotenuse.

This method draws half-edges of the conformal layer neighboring each vertex.

Note for irregular shapes the distance along the vertex has to be different for the two neighboring perpendicular bisectors to create a conformal layer of a fixed thickness. One may desire that the conformal layer appears like a continuous film. Consider $\theta_i$ as the one formed between a perpendicular bisector $e_i$ and an angular bisector $a_i$, and $\theta_{i+1}$ as the one formed between a perpendicular bisector $e_{i+1}$ and an angular bisector $a_i$. The increments from the vertex at $a_i$ are weighted as $\sec\theta$, so that if without loss of generality $\theta_i < \theta_{i+1}$, then $\sec(\theta_i) < \sec(\theta_{i+1}$ and it is the conformal coordinate associated with the perpendicular bisector $e_{i+1}$ that is farther out. Then it is possible to, along the line defined between $\tilde{\mathbf{b}}_i$ and $\tilde{\mathbf{b}}_i'$, where a tilde indicates the conformal coordinate analog, move the coordinate so that it is collinear with the line defined between $\tilde{\mathbf{b}}_{i-1}$ and $\tilde{\mathbf{b}}_i''$ (double prime indicating it is generally different, since the factors will differ). This is equivalent to finding the intercept of the two lines and using that as the common conformal coordinate $\tilde{\mathbf{b}}_i'$ for the angular bisector $a_i$. 

\end{document}
